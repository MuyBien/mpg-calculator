
.docker:
  image: docker:18.09.7
  stage: docker
  cache: {}
  dependencies: []
  services:
    - docker:18.09.7-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u $CI_REGISTRY_USER registry.gitlab.com --password-stdin
    - docker pull registry.gitlab.com/muybien/mpg-calculator:master || true
  allow_failure: true
  timeout: 15m

review:image:
  extends: .docker
  needs: ["test:unit"]
  variables:
    IMAGE_TAG: "$CI_COMMIT_REF_SLUG"
  script:
    - docker build --cache-from registry.gitlab.com/muybien/mpg-calculator:master -t registry.gitlab.com/muybien/mpg-calculator:$IMAGE_TAG .
    - docker push registry.gitlab.com/muybien/mpg-calculator:$IMAGE_TAG
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success

stable:image:
  extends: .docker
  variables:
    IMAGE_TAG: "$CI_COMMIT_REF_NAME"
  script:
    - docker build --cache-from registry.gitlab.com/muybien/mpg-calculator:master -t registry.gitlab.com/muybien/mpg-calculator:latest -t registry.gitlab.com/muybien/mpg-calculator:$IMAGE_TAG .
    - docker push registry.gitlab.com/muybien/mpg-calculator:$IMAGE_TAG
    - docker push registry.gitlab.com/muybien/mpg-calculator:latest
  rules:
    - if: $CI_COMMIT_TAG
